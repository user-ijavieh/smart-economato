<div class="header-inventario">
  <h1>Inventario</h1>
</div>

<div class="contenedor-principal">
  <div class="controles">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar producto..."
      (keydown)="onSearch()"
    />
    @if (isAdmin) {
      <button id="btnAgregarProducto" (click)="toggleForm()">
        {{ showForm ? 'Cerrar Formulario' : 'Agregar Producto' }}
      </button>
    }
    <button (click)="showAll()">Mostrar Todos</button>
    @if (hasActiveFilters()) {
      <button (click)="clearFilters()">Limpiar Filtros</button>
    }
  </div>

  @if (showForm) {
    <app-product-form
      [product]="selectedProduct"
      [suppliers]="suppliers"
      (save)="onSaveProduct($event)"
      (cancel)="onCancelForm()"
      (delete)="onDeleteProduct()"
    ></app-product-form>
  }

  <div class="tabla-contenedor">
    <table>
      <thead>
        <tr>
          <th class="sortable" (click)="onSortChange('id')" [attr.data-sort-dir]="getSortDir('id')">
            ID
          </th>
          <th
            class="sortable"
            (click)="onSortChange('name')"
            [attr.data-sort-dir]="getSortDir('name')"
          >
            Nombre
          </th>
          <th
            class="sortable"
            (click)="onSortChange('type')"
            [attr.data-sort-dir]="getSortDir('type')"
          >
            Tipo
          </th>
          <th
            class="sortable"
            (click)="onSortChange('unitPrice')"
            [attr.data-sort-dir]="getSortDir('unitPrice')"
          >
            Precio (€)
          </th>
          <th
            class="sortable"
            (click)="onSortChange('currentStock')"
            [attr.data-sort-dir]="getSortDir('currentStock')"
          >
            Stock
          </th>
          <th>Unidad</th>
          <th
            class="sortable"
            (click)="onSortChange('supplier')"
            [attr.data-sort-dir]="getSortDir('supplier')"
          >
            Proveedor
          </th>
          @if (isAdmin) {
            <th>Acciones</th>
          }
        </tr>
      </thead>
      <tbody [class.loading]="loading && !initialLoad">
        @if (loading && initialLoad) {
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <tr class="skeleton-row">
              <td><span class="skeleton skeleton-text"></span></td>
              <!-- ID -->
              <td><span class="skeleton skeleton-text" style="width: 150px"></span></td>
              <!-- Name -->
              <td><span class="skeleton skeleton-text" style="width: 80px"></span></td>
              <!-- Type -->
              <td><span class="skeleton skeleton-text" style="width: 60px"></span></td>
              <!-- Price -->
              <td><span class="skeleton skeleton-text" style="width: 60px"></span></td>
              <!-- Stock -->
              <td><span class="skeleton skeleton-text" style="width: 40px"></span></td>
              <!-- Unit -->
              <td><span class="skeleton skeleton-text" style="width: 100px"></span></td>
              <!-- Supplier -->
              @if (isAdmin) {
                <td><span class="skeleton skeleton-text" style="width: 30px"></span></td>
                <!-- Actions -->
              }
            </tr>
          }
        } @else {
          @for (product of products; track product.id) {
            <tr [class.alerta]="isLowStock(product)">
              <td>{{ product.id }}</td>
              <td>{{ product.name }}</td>
              <td>{{ product.type || '—' }}</td>
              <td>{{ product.unitPrice | number: '1.2-2' }} €</td>
              <td>{{ product.currentStock }}</td>
              <td>{{ product.unit }}</td>
              <td>{{ product.supplier?.name || '—' }}</td>
              @if (isAdmin) {
                <td>
                  <button class="btn-editar" (click)="editProduct(product)" title="Editar">✏️</button>
                </td>
              }
            </tr>
          }
        }
        @if (products.length === 0 && !loading && !initialLoad) {
          <tr>
            <td [attr.colspan]="isAdmin ? 8 : 7" style="text-align: center; padding: 2rem">
              No se encontraron productos
            </td>
          </tr>
        }
      </tbody>
      <tfoot>
        <tr>
          <td colspan="8">
            <div class="pagination-controls">
              <div class="pagination-info">
                Total: {{ totalElements }} productos | Página {{ page + 1 }} de {{ totalPages }}
              </div>
              <div class="pagination-actions">
                <div class="items-per-page">
                  <label for="itemsPerPage">Mostrar:</label>
                  <input
                    id="itemsPerPage"
                    type="number"
                    min="1"
                    [value]="size"
                    (change)="onSizeChange($event)"
                    class="pagination-size-input"
                  />
                </div>
                <button (click)="onPageChange(page - 1)" [disabled]="page === 0 || loading">
                  Anterior
                </button>
                <button
                  (click)="onPageChange(page + 1)"
                  [disabled]="page >= totalPages - 1 || loading"
                >
                  Siguiente
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Modal de edición -->
@if (showEditModal && selectedProduct) {
  <app-product-edit-modal
    [product]="selectedProduct"
    [suppliers]="suppliers"
    (save)="onSaveEditedProduct($event)"
    (delete)="onDeleteProductFromModal()"
    (close)="onCloseEditModal()"
  ></app-product-edit-modal>
}

<!-- Confirm Dialog -->
<app-confirm-dialog></app-confirm-dialog>

<!-- Toast Notifications -->
<app-toast [toasts]="(messageService.toasts | async) || []"></app-toast>
