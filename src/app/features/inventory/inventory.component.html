<div class="header-inventario">
  <h1>Inventario</h1>
</div>

<div class="contenedor-principal">
  <div class="controles">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar producto..."
      (ngModelChange)="onSearch()"
    />
    <button (click)="onSearch()">Buscar</button>
    @if (isAdmin) {
      <button id="btnAgregarProducto" (click)="openCreateModal()">Agregar Producto</button>
    }
    @if (hasActiveFilters()) {
      <button (click)="clearFilters()">Limpiar Filtros</button>
    }
    <button class="btn-excel" (click)="exportToExcel()" title="Descargar Excel">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="currentColor"
        viewBox="0 0 16 16"
      >
        <path
          d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"
        />
        <path
          d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"
        />
      </svg>
      Descargar Excel
    </button>
  </div>

  @if (showForm) {
    <app-product-form
      [product]="selectedProduct"
      [suppliers]="suppliers"
      (save)="onSaveProduct($event)"
      (cancel)="onCancelForm()"
      (delete)="onDeleteProduct()"
    ></app-product-form>
  }

  <div class="tabla-contenedor">
    <table>
      <thead>
        <tr>
          <th
            class="sortable"
            (click)="onSortChange('name')"
            [attr.data-sort-dir]="getSortDir('name')"
          >
            Nombre
          </th>
          <th
            class="sortable hide-on-mobile"
            (click)="onSortChange('type')"
            [attr.data-sort-dir]="getSortDir('type')"
          >
            Tipo
          </th>
          <th
            class="sortable hide-on-mobile"
            (click)="onSortChange('unitPrice')"
            [attr.data-sort-dir]="getSortDir('unitPrice')"
          >
            Precio (€)
          </th>
          <th
            class="sortable"
            (click)="onSortChange('currentStock')"
            [attr.data-sort-dir]="getSortDir('currentStock')"
          >
            Stock
          </th>
          <th class="hide-on-mobile">Unidad</th>
          <th
            class="sortable hide-on-mobile"
            (click)="onSortChange('supplier')"
            [attr.data-sort-dir]="getSortDir('supplier')"
          >
            Proveedor
          </th>
          @if (isAdmin) {
            <th class="hide-on-mobile">Acciones</th>
          }
          <th class="show-on-mobile-only mobile-icon-col"></th>
        </tr>
      </thead>
      <tbody [class.loading]="loading && !initialLoad">
        @if (loading && initialLoad) {
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <tr class="skeleton-row">
              <td><span class="skeleton skeleton-text" style="width: 150px"></span></td>
              <!-- Name -->
              <td class="hide-on-mobile">
                <span class="skeleton skeleton-text" style="width: 80px"></span>
              </td>
              <!-- Type -->
              <td class="hide-on-mobile">
                <span class="skeleton skeleton-text" style="width: 60px"></span>
              </td>
              <!-- Price -->
              <td><span class="skeleton skeleton-text" style="width: 60px"></span></td>
              <!-- Stock -->
              <td class="hide-on-mobile">
                <span class="skeleton skeleton-text" style="width: 40px"></span>
              </td>
              <!-- Unit -->
              <td class="hide-on-mobile">
                <span class="skeleton skeleton-text" style="width: 100px"></span>
              </td>
              <!-- Supplier -->
              @if (isAdmin) {
                <td class="hide-on-mobile">
                  <span class="skeleton skeleton-text" style="width: 30px"></span>
                </td>
                <!-- Actions -->
              }
              <td class="show-on-mobile-only mobile-icon-col"></td>
            </tr>
          }
        } @else {
          @for (product of products; track product.id) {
            <tr
              [class.alerta]="isLowStock(product)"
              class="clickable-row"
              (click)="openDetailModal(product)"
            >
              <td>{{ product.name }}</td>
              <td class="hide-on-mobile">{{ product.type || '—' }}</td>
              <td class="hide-on-mobile">{{ product.unitPrice | number: '1.2-2' }} €</td>
              <td>{{ product.currentStock }}</td>
              <td class="hide-on-mobile">{{ product.unit }}</td>
              <td class="hide-on-mobile">{{ product.supplier?.name || '—' }}</td>
              @if (isAdmin) {
                <td class="hide-on-mobile" (click)="$event.stopPropagation()">
                  <button
                    class="btn-stock"
                    (click)="openStockModal(product)"
                    title="Ajustar Stock"
                    style="margin-right: 0.5rem"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      fill="currentColor"
                      viewBox="0 0 16 16"
                    >
                      <path
                        d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"
                      />
                    </svg>
                  </button>
                  <button class="btn-editar" (click)="editProduct(product)" title="Editar">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      fill="currentColor"
                      viewBox="0 0 16 16"
                    >
                      <path
                        d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"
                      />
                      <path
                        fill-rule="evenodd"
                        d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"
                      />
                    </svg>
                  </button>
                </td>
              }
              <td class="show-on-mobile-only mobile-icon-col">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
                  />
                </svg>
              </td>
            </tr>
          }
        }
        @if (products.length === 0 && !loading && !initialLoad) {
          <tr>
            <td [attr.colspan]="isAdmin ? 7 : 6" style="text-align: center; padding: 2rem">
              No se encontraron productos
            </td>
          </tr>
        }
      </tbody>
      <tfoot>
        <tr>
          <td colspan="8">
            <div class="pagination-controls">
              <div class="pagination-info">
                Total: {{ totalElements }} productos | Página {{ page + 1 }} de {{ totalPages }}
              </div>
              <div class="pagination-actions">
                <div class="items-per-page">
                  <label for="itemsPerPage">Mostrar:</label>
                  <select
                    id="itemsPerPage"
                    [value]="size"
                    (change)="onSizeChange($event)"
                    class="pagination-size-input"
                  >
                    <option [value]="10">10</option>
                    <option [value]="15">15</option>
                    <option [value]="20">20</option>
                    <option [value]="50">50</option>
                  </select>
                </div>
                <button (click)="onPageChange(page - 1)" [disabled]="page === 0 || loading">
                  Anterior
                </button>
                <button
                  (click)="onPageChange(page + 1)"
                  [disabled]="page >= totalPages - 1 || loading"
                >
                  Siguiente
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Modal de creación -->
@if (showCreateModal) {
  <app-product-create-modal
    [suppliers]="suppliers"
    (save)="onSaveProduct($event)"
    (close)="onCloseCreateModal()"
  ></app-product-create-modal>
}

<!-- Modal de edición -->
@if (showEditModal && selectedProduct) {
  <app-product-edit-modal
    [product]="selectedProduct"
    [suppliers]="suppliers"
    (save)="onSaveEditedProduct($event)"
    (delete)="onDeleteProductFromModal()"
    (close)="onCloseEditModal()"
  ></app-product-edit-modal>
}

<!-- Confirm Dialog -->
<app-confirm-dialog></app-confirm-dialog>

<!-- Toast Notifications -->
<app-toast [toasts]="(messageService.toasts | async) || []"></app-toast>

<!-- Confirm Dialog -->
<app-confirm-dialog></app-confirm-dialog>

<!-- Toast Notifications -->
<app-toast [toasts]="(messageService.toasts | async) || []"></app-toast>

<!-- Modal de ajuste de Stock -->
@if (showStockModal && selectedProduct) {
  <app-stock-update-modal
    [product]="selectedProduct"
    (save)="onSaveStock($event)"
    (close)="onCloseStockModal()"
  ></app-stock-update-modal>
}

<!-- Modal de detalles del producto -->
@if (showDetailModal && selectedProduct) {
  <app-product-detail-modal
    [product]="selectedProduct"
    [isAdmin]="isAdmin"
    (close)="onCloseDetailModal()"
    (edit)="onEditFromDetail($event)"
    (adjustStock)="onAdjustStockFromDetail($event)"
  ></app-product-detail-modal>
}
