<div class="header-inventario">
  <h1>Inventario</h1>
</div>

<div class="contenedor-principal">
  <div class="controles">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar producto..."
      (keyup.enter)="onSearch()"
    />
    <button (click)="onSearch()">Buscar</button>
    <button id="btnAgregarProducto" (click)="toggleForm()">
      {{ showForm ? 'Cerrar Formulario' : 'Agregar Producto' }}
    </button>
  </div>

  @if (showForm) {
    <app-product-form
      [product]="selectedProduct"
      [suppliers]="suppliers"
      (save)="onSaveProduct($event)"
      (cancel)="onCancelForm()"
      (delete)="onDeleteProduct()"
    ></app-product-form>
  }

  <div class="tabla-contenedor">
    <table>
      <thead>
        <tr>
          <th class="sortable" (click)="onSortChange('id')" [attr.data-sort-dir]="getSortDir('id')">
            ID
          </th>
          <th
            class="sortable"
            (click)="onSortChange('name')"
            [attr.data-sort-dir]="getSortDir('name')"
          >
            Nombre
          </th>
          <th
            class="sortable"
            (click)="onSortChange('type')"
            [attr.data-sort-dir]="getSortDir('type')"
          >
            Tipo
          </th>
          <th
            class="sortable"
            (click)="onSortChange('unitPrice')"
            [attr.data-sort-dir]="getSortDir('unitPrice')"
          >
            Precio (€)
          </th>
          <th
            class="sortable"
            (click)="onSortChange('currentStock')"
            [attr.data-sort-dir]="getSortDir('currentStock')"
          >
            Stock
          </th>
          <th>Unidad</th>
          <th
            class="sortable"
            (click)="onSortChange('supplier')"
            [attr.data-sort-dir]="getSortDir('supplier')"
          >
            Proveedor
          </th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @if (loading) {
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <tr class="skeleton-row">
              <td><span class="skeleton skeleton-text"></span></td>
              <!-- ID -->
              <td><span class="skeleton skeleton-text" style="width: 150px"></span></td>
              <!-- Name -->
              <td><span class="skeleton skeleton-text" style="width: 80px"></span></td>
              <!-- Type -->
              <td><span class="skeleton skeleton-text" style="width: 60px"></span></td>
              <!-- Price -->
              <td><span class="skeleton skeleton-text" style="width: 60px"></span></td>
              <!-- Stock -->
              <td><span class="skeleton skeleton-text" style="width: 40px"></span></td>
              <!-- Unit -->
              <td><span class="skeleton skeleton-text" style="width: 100px"></span></td>
              <!-- Supplier -->
              <td><span class="skeleton skeleton-text" style="width: 30px"></span></td>
              <!-- Actions -->
            </tr>
          }
        } @else {
          @for (product of products; track product.id) {
            <tr [class.alerta]="isLowStock(product)">
              <td>{{ product.id }}</td>
              <td>{{ product.name }}</td>
              <td>{{ product.type || '—' }}</td>
              <td>{{ product.unitPrice | number: '1.2-2' }} €</td>
              <td>{{ product.currentStock }}</td>
              <td>{{ product.unit }}</td>
              <td>{{ product.supplier?.name || '—' }}</td>
              <td>
                <button class="btn-editar" (click)="editProduct(product)" title="Editar">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 16 16"
                  >
                    <path
                      d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"
                    />
                    <path
                      fill-rule="evenodd"
                      d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"
                    />
                  </svg>
                </button>
              </td>
            </tr>
          }
        }
        @if (products.length === 0 && !loading) {
          <tr>
            <td colspan="8" style="text-align: center; padding: 2rem">
              No se encontraron productos
            </td>
          </tr>
        }
      </tbody>
      <tfoot>
        <tr>
          <td colspan="8">
            <div class="pagination-controls">
              <div class="pagination-info">
                Total: {{ totalElements }} productos | Página {{ page + 1 }} de {{ totalPages }}
              </div>
              <div class="pagination-actions">
                <div class="items-per-page">
                  <label for="itemsPerPage">Mostrar:</label>
                  <select
                    id="itemsPerPage"
                    [value]="size"
                    (change)="onSizeChange($event)"
                    class="pagination-size-input"
                  >
                    <option [value]="10">10</option>
                    <option [value]="15">15</option>
                    <option [value]="20">20</option>
                    <option [value]="50">50</option>
                  </select>
                </div>
                <button (click)="onPageChange(page - 1)" [disabled]="page === 0 || loading">
                  Anterior
                </button>
                <button
                  (click)="onPageChange(page + 1)"
                  [disabled]="page >= totalPages - 1 || loading"
                >
                  Siguiente
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
